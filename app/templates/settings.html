{% extends "base.html" %}
{% block title %}Settings - Vault{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" class="me-2"><path d="M8 0a8.2 8.2 0 01.701.031C11.444.158 13.53 1.36 14.63 3.25a8.086 8.086 0 011.37 4.5v.25a8.25 8.25 0 01-16 .128V8a8.086 8.086 0 011.37-4.5C2.47 1.36 4.556.158 7.299.031A8.2 8.2 0 018 0zm0 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13z"/></svg>
        Settings
    </h1>
</div>

<div class="row g-4">
    <!-- Profile -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Profile</div>
            <div class="card-body">
                <form id="profile-form">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" value="{{ user.username }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" value="{{ user.email }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" value="{{ user.full_name }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-control" value="{{ user.role }}" disabled>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Change Password</div>
            <div class="card-body">
                <form id="password-form">
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new-password" minlength="8" required>
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirm-password" minlength="8" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Update Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Connection Info -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">Connection Info</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><td class="text-muted" style="width:200px">S3 Endpoint</td><td class="mono" id="s3-endpoint">Loading...</td></tr>
                        <tr><td class="text-muted">S3 Bucket</td><td class="mono" id="s3-bucket">Loading...</td></tr>
                        <tr><td class="text-muted">App Version</td><td class="mono" id="app-version">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const health = await Vault.api('/health');
        document.getElementById('app-version').textContent = health.version;
    } catch (e) {}
    // These are shown for informational purposes from server-rendered context
    document.getElementById('s3-endpoint').textContent = '(configured server-side)';
    document.getElementById('s3-bucket').textContent = '(configured server-side)';
});

document.getElementById('password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const pw = document.getElementById('new-password').value;
    const confirm = document.getElementById('confirm-password').value;
    if (pw !== confirm) {
        Vault.toast('Passwords do not match', 'warning');
        return;
    }
    try {
        await Vault.api(`/api/admin/users/{{ user.id }}/reset-password`, {
            method: 'POST',
            body: { new_password: pw },
        });
        Vault.toast('Password updated', 'success');
        document.getElementById('password-form').reset();
    } catch (err) {
        Vault.toast(err.message, 'danger');
    }
});
</script>
{% endblock %}
